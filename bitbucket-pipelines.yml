options:
  docker: true
  size: 2x

definitions:
  services:
    docker:
      memory: 4096
    postgres:
      image: postgres
      environment:
        POSTGRES_DB: test_xapi_db
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: xapiserver

  steps:
    - step: &npm-install-and-test
        name: '‚ö° npm install and test'
        image: node:16
        services:
          - postgres
          - docker
        size: 2x
        script:
          - export HUSKY=0
          - npm i
          - curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-Linux-x86_64 -o /usr/local/bin/docker-compose
          - chmod +x /usr/local/bin/docker-compose
          - docker-compose -f docker-compose.test.yml up -d
          - npm run test:codecov
          - docker-compose -f docker-compose.test.yml down
        artifacts:
          - node_modules/**/*
        caches:
          - node

    - step: &commitlint
        name: 'üìù conventional commits check'
        image: node:16
        script:
          - /bin/bash commitlint-pipeline-check.sh

    - step: &version-bump
        name: 'üè∑Ô∏è version bump'
        trigger: 'manual'
        image: node:16
        script:
          - npm run release
          # This step will fail if 'master' branch write permissions isn't set to 'everyone'.
          - git push --follow-tags origin master

    - step: &docker-build-and-push-to-ecr
        name: 'üöÄ docker build + push to ECR'
        deployment: release
        image: python:3.9-alpine
        services:
          - docker
        script:
          - pip3 install -U awscli
          # DOCKER_REPO_URL is a workspace wide variable.
          - aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin $DOCKER_REPO_URL
          - docker build -t xapi-server .
          - export REPO=$DOCKER_REPO_URL/$DOCKER_REPO_NAME
          - docker tag xapi-server:latest $REPO:$BITBUCKET_TAG
          - docker tag xapi-server:latest $REPO:alpha
          - docker push $REPO:$BITBUCKET_TAG
          - docker push $REPO:alpha

    - step: &npm-install-prod-and-build
        name: '‚ö° npm install and build'
        image: node:16
        script:
          - git reset --hard origin/master
          - git log --oneline -1
          - npm ci --only-production
          - npm run build
        artifacts:
          - node_modules/**/*
          - dist/**

    - step: &npm-build
        name: '‚ö° npm build'
        image: node:16-alpine
        script:
          - npm run build
        artifacts:
          - dist/**

    - step: &docker-build
        name: 'üê≥ docker build'
        services:
          - docker
        script:
          - docker build -t xapi-server .

    - step: &deploy-to-alpha
        name: 'üîî deploy to alpha'
        artifacts:
          download: false
        script:
          - pipe: atlassian/aws-ecs-deploy:1.6.1
            variables:
              # These AWS values are workspace variables for alpha-dev.
              AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_ALPHA_OLD
              AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_ALPHA_OLD
              AWS_DEFAULT_REGION: 'ap-northeast-2'
              CLUSTER_NAME: 'kidsloop-alpha'
              SERVICE_NAME: 'kidsloop-alpha-xapi'
              FORCE_NEW_DEPLOYMENT: 'true'
              WAIT: 'true'
          - pipe: docker://cabauman/slack-notify-commits:0.6.0
            variables:
              WEBHOOK_URL: $SLACK_WEBHOOK
              MESSAGE: 'üöÄ A new build of xAPI service has been deployed to *alpha*.'
              BITBUCKET_USER: $BITBUCKET_PIPELINE_READER_USER
              BITBUCKET_APP_PASSWORD: $BITBUCKET_PIPELINE_READER_APP_PASSWORD

pipelines:
  pull-requests:
    '**':
      - step: *npm-install-and-test
      - step: *commitlint
      - step: *npm-build
      - step: *docker-build

  branches:
    master:
      - step: *version-bump
      - step: *npm-install-prod-and-build
      - step: *docker-build-and-push-to-ecr
      - step: *deploy-to-alpha
