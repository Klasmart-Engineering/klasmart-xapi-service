pipelines:
  custom:
    deploy:
      - step:
          name: "Build & Push Docker image"
          image: python:3.7.4-alpine3.10
          script:
            - pip3 install -U awscli
            - aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin $DOCKER_REPO_URL
            - docker build -t xapi-server .
            - docker tag xapi-server:latest $DOCKER_REPO_URL/$DOCKER_REPO_NAME:$BITBUCKET_COMMIT
            - docker push $DOCKER_REPO_URL/$DOCKER_REPO_NAME:$BITBUCKET_COMMIT
          services:
            - docker

definitions:
  caches:
    nodemodules: ./node_modules
